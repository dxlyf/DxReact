# Node.js æ ¸å¿ƒæ¨¡å—åº”ç”¨åœºæ™¯ä¸åŠŸèƒ½è¯¦è§£

## ğŸ“ **fs æ¨¡å— - æ–‡ä»¶ç³»ç»Ÿæ“ä½œ**

### åŠŸèƒ½æè¿°
æä¾›æ–‡ä»¶å’Œç›®å½•çš„åˆ›å»ºã€è¯»å–ã€å†™å…¥ã€åˆ é™¤ç­‰æ“ä½œï¼Œæ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ–¹å¼ã€‚

### å…¸å‹åº”ç”¨åœºæ™¯

#### 1. é…ç½®æ–‡ä»¶è¯»å†™
```javascript
const fs = require('fs').promises;

// è¯»å–åº”ç”¨é…ç½®
async function loadConfig() {
    try {
        const configData = await fs.readFile('./config.json', 'utf8');
        return JSON.parse(configData);
    } catch (error) {
        // å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®
        const defaultConfig = { port: 3000, database: 'mongodb://localhost/app' };
        await fs.writeFile('./config.json', JSON.stringify(defaultConfig, null, 2));
        return defaultConfig;
    }
}
```

#### 2. æ—¥å¿—è®°å½•ç³»ç»Ÿ
```javascript
const fs = require('fs');
const path = require('path');

class Logger {
    constructor(logDir = './logs') {
        this.logDir = logDir;
        this.ensureLogDirectory();
    }

    ensureLogDirectory() {
        if (!fs.existsSync(this.logDir)) {
            fs.mkdirSync(this.logDir, { recursive: true });
        }
    }

    log(message, level = 'INFO') {
        const timestamp = new Date().toISOString();
        const logMessage = `[${timestamp}] ${level}: ${message}\n`;
        const logFile = path.join(this.logDir, `${new Date().toDateString()}.log`);
        
        // å¼‚æ­¥å†™å…¥ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
        fs.appendFile(logFile, logMessage, (err) => {
            if (err) console.error('æ—¥å¿—å†™å…¥å¤±è´¥:', err);
        });
    }
}
```

#### 3. é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆWebæœåŠ¡å™¨ï¼‰
```javascript
const http = require('http');
const fs = require('fs');
const path = require('path');

const server = http.createServer(async (req, res) => {
    let filePath = '.' + req.url;
    if (filePath === './') filePath = './index.html';

    try {
        const content = await fs.promises.readFile(filePath);
        const ext = path.extname(filePath);
        const contentType = {
            '.html': 'text/html',
            '.css': 'text/css',
            '.js': 'application/javascript',
            '.json': 'application/json',
            '.png': 'image/png'
        }[ext] || 'text/plain';

        res.writeHead(200, { 'Content-Type': contentType });
        res.end(content);
    } catch (error) {
        res.writeHead(404);
        res.end('æ–‡ä»¶æœªæ‰¾åˆ°');
    }
});
```

## ğŸŒŠ **stream æ¨¡å— - æµå¼æ•°æ®å¤„ç†**

### åŠŸèƒ½æè¿°
æä¾›å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼Œç”¨äºé«˜æ•ˆå¤„ç†å¤§é‡æ•°æ®ï¼Œé¿å…å†…å­˜æº¢å‡ºã€‚

### å…¸å‹åº”ç”¨åœºæ™¯

#### 1. å¤§æ–‡ä»¶å¤„ç†
```javascript
const fs = require('fs');
const { Transform } = require('stream');

// å¤§æ–‡ä»¶å¤åˆ¶ï¼ˆå†…å­˜å‹å¥½ï¼‰
function copyLargeFile(source, destination) {
    return new Promise((resolve, reject) => {
        const readStream = fs.createReadStream(source);
        const writeStream = fs.createWriteStream(destination);

        readStream.pipe(writeStream);
        
        writeStream.on('finish', resolve);
        writeStream.on('error', reject);
        readStream.on('error', reject);
    });
}

// æµå¼æ–‡ä»¶å¤„ç†ï¼šå®æ—¶å‹ç¼©/åŠ å¯†
const zlib = require('zlib');
function compressFile(inputPath, outputPath) {
    return fs.createReadStream(inputPath)
        .pipe(zlib.createGzip())
        .pipe(fs.createWriteStream(outputPath));
}
```

#### 2. å®æ—¶æ•°æ®å¤„ç†ç®¡é“
```javascript
const { Transform, pipeline } = require('stream');

// è‡ªå®šä¹‰è½¬æ¢æµï¼šæ•°æ®æ¸…æ´—
class DataCleaner extends Transform {
    _transform(chunk, encoding, callback) {
        try {
            // ç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼Œè½¬æ¢ä¸ºå¤§å†™
            const cleaned = chunk.toString()
                .replace(/[^a-zA-Z0-9\s]/g, '')
                .toUpperCase();
            this.push(cleaned);
            callback();
        } catch (error) {
            callback(error);
        }
    }
}

// æ•°æ®å¤„ç†ç®¡é“
const cleaner = new DataCleaner();
fs.createReadStream('./raw-data.txt')
    .pipe(cleaner)
    .pipe(fs.createWriteStream('./cleaned-data.txt'))
    .on('finish', () => console.log('æ•°æ®å¤„ç†å®Œæˆ'));
```

#### 3. HTTPè¯·æ±‚/å“åº”æµå¼å¤„ç†
```javascript
const http = require('http');
const fs = require('fs');

// æµå¼è§†é¢‘æ’­æ”¾
http.createServer((req, res) => {
    const videoPath = './sample.mp4';
    const stat = fs.statSync(videoPath);
    const fileSize = stat.size;
    const range = req.headers.range;

    if (range) {
        // æ”¯æŒæ–­ç‚¹ç»­ä¼ 
        const parts = range.replace(/bytes=/, "").split("-");
        const start = parseInt(parts[0], 10);
        const end = parts[1] ? parseInt(parts[1], 10) : fileSize - 1;
        const chunksize = (end - start) + 1;
        
        const file = fs.createReadStream(videoPath, { start, end });
        const head = {
            'Content-Range': `bytes ${start}-${end}/${fileSize}`,
            'Accept-Ranges': 'bytes',
            'Content-Length': chunksize,
            'Content-Type': 'video/mp4',
        };
        
        res.writeHead(206, head);
        file.pipe(res);
    } else {
        // å®Œæ•´æ–‡ä»¶ä¼ è¾“
        const head = {
            'Content-Length': fileSize,
            'Content-Type': 'video/mp4',
        };
        res.writeHead(200, head);
        fs.createReadStream(videoPath).pipe(res);
    }
});
```

## ğŸ‘¶ **child_process æ¨¡å— - å­è¿›ç¨‹ç®¡ç†**

### åŠŸèƒ½æè¿°
ç”¨äºåˆ›å»ºå’Œç®¡ç†å­è¿›ç¨‹ï¼Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€å…¶ä»–è„šæœ¬æˆ–CPUå¯†é›†å‹ä»»åŠ¡ã€‚

### å…¸å‹åº”ç”¨åœºæ™¯

#### 1. æ‰§è¡Œç³»ç»Ÿå‘½ä»¤å’ŒShellè„šæœ¬
```javascript
const { exec, spawn } = require('child_process');

// æ‰§è¡Œç®€å•çš„ç³»ç»Ÿå‘½ä»¤
exec('ls -la', (error, stdout, stderr) => {
    if (error) {
        console.error(`æ‰§è¡Œé”™è¯¯: ${error}`);
        return;
    }
    console.log(`ç›®å½•å†…å®¹:\n${stdout}`);
});

// æ‰§è¡Œå¤æ‚çš„Shellè„šæœ¬
function runShellScript(scriptPath, args = []) {
    return new Promise((resolve, reject) => {
        const child = spawn('bash', [scriptPath, ...args]);
        
        let output = '';
        let errorOutput = '';

        child.stdout.on('data', (data) => {
            output += data.toString();
            console.log(`STDOUT: ${data}`);
        });

        child.stderr.on('data', (data) => {
            errorOutput += data.toString();
            console.error(`STDERR: ${data}`);
        });

        child.on('close', (code) => {
            if (code === 0) {
                resolve(output);
            } else {
                reject(new Error(`è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : ${code}\n${errorOutput}`));
            }
        });
    });
}
```

#### 2. CPUå¯†é›†å‹ä»»åŠ¡åˆ†ç¦»
```javascript
const { fork } = require('child_process');

// ä¸»è¿›ç¨‹ï¼šåˆ›å»ºå­è¿›ç¨‹å¤„ç†è®¡ç®—ä»»åŠ¡
function calculateFibonacci(n) {
    return new Promise((resolve, reject) => {
        const child = fork('./fibonacci-worker.js');
        
        child.send({ number: n });
        
        child.on('message', (result) => {
            resolve(result);
            child.kill(); // ä»»åŠ¡å®Œæˆï¼Œæ¸…ç†å­è¿›ç¨‹
        });
        
        child.on('error', reject);
        
        // è®¾ç½®è¶…æ—¶ä¿æŠ¤
        setTimeout(() => {
            child.kill();
            reject(new Error('è®¡ç®—è¶…æ—¶'));
        }, 10000);
    });
}

// fibonacci-worker.js - å­è¿›ç¨‹æ–‡ä»¶
process.on('message', (data) => {
    const result = fibonacci(data.number);
    process.send(result);
});

function fibonacci(n) {
    if (n <= 1) return n;
    return fibonacci(n - 1) + fibonacci(n - 2);
}
```

#### 3. å¤šè¿›ç¨‹ä»»åŠ¡å¹¶è¡Œå¤„ç†
```javascript
const { Worker, isMainThread, parentPort, workerData } = require('worker_threads');

// ä¸»è¿›ç¨‹ï¼šä»»åŠ¡åˆ†å‘
if (isMainThread) {
    function parallelProcessTasks(tasks, workerCount = 4) {
        return new Promise((resolve) => {
            const chunkSize = Math.ceil(tasks.length / workerCount);
            const workers = [];
            let completedWorkers = 0;
            const results = [];

            for (let i = 0; i < workerCount; i++) {
                const workerTasks = tasks.slice(i * chunkSize, (i + 1) * chunkSize);
                
                const worker = new Worker(__filename, {
                    workerData: { tasks: workerTasks, workerId: i }
                });

                worker.on('message', (result) => {
                    results.push(...result);
                    completedWorkers++;
                    
                    if (completedWorkers === workerCount) {
                        resolve(results);
                    }
                });

                workers.push(worker);
            }
        });
    }
} else {
    // å­çº¿ç¨‹ï¼šä»»åŠ¡å¤„ç†
    const processedResults = workerData.tasks.map(task => ({
        ...task,
        processedBy: workerData.workerId,
        processedAt: new Date().toISOString()
    }));
    
    parentPort.postMessage(processedResults);
}
```

#### 4. å¤–éƒ¨å·¥å…·é›†æˆ
```javascript
const { spawn } = require('child_process');
const path = require('path');

// é›†æˆImageMagickè¿›è¡Œå›¾ç‰‡å¤„ç†
function convertImage(inputPath, outputPath, format = 'jpeg') {
    return new Promise((resolve, reject) => {
        const args = [
            inputPath,
            '-resize', '50%',          // ç¼©æ”¾50%
            '-quality', '85',          // è´¨é‡85%
            `${format}:${outputPath}`  // è¾“å‡ºæ ¼å¼å’Œè·¯å¾„
        ];

        const convert = spawn('convert', args);
        
        let stderr = '';
        convert.stderr.on('data', (data) => {
            stderr += data.toString();
        });

        convert.on('close', (code) => {
            if (code === 0) {
                resolve(`å›¾ç‰‡è½¬æ¢æˆåŠŸ: ${outputPath}`);
            } else {
                reject(new Error(`ImageMagickè½¬æ¢å¤±è´¥: ${stderr}`));
            }
        });

        convert.on('error', (error) => {
            reject(new Error(`æ— æ³•å¯åŠ¨ImageMagick: ${error.message}`));
        });
    });
}
```

## ğŸ¯ **æ¨¡å—é€‰æ‹©æŒ‡å—**

| åœºæ™¯ | æ¨èæ¨¡å— | åŸå›  |
|------|----------|------|
| è¯»å†™å°æ–‡ä»¶ | **fs** | ç®€å•ç›´æ¥ï¼Œä»£ç æ¸…æ™° |
| å¤„ç†å¤§æ–‡ä»¶ | **stream** | å†…å­˜æ•ˆç‡é«˜ï¼Œä¸ä¼šæº¢å‡º |
| å®æ—¶æ•°æ®å¤„ç† | **stream** | ä½å»¶è¿Ÿï¼Œç®¡é“å¼å¤„ç† |
| æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ | **child_process** | å¿…è¦çš„ç³»ç»Ÿäº¤äº’ |
| CPUå¯†é›†å‹ä»»åŠ¡ | **child_process** | é¿å…é˜»å¡äº‹ä»¶å¾ªç¯ |
| å¹¶è¡Œä»»åŠ¡å¤„ç† | **child_process** + Worker | å……åˆ†åˆ©ç”¨å¤šæ ¸CPU |

è¿™ä¸‰ä¸ªæ¨¡å—æ„æˆäº†Node.jså¤„ç†I/Oæ“ä½œã€æ•°æ®æµå’Œç³»ç»Ÿäº¤äº’çš„æ ¸å¿ƒèƒ½åŠ›ï¼Œæ­£ç¡®é€‰æ‹©å’Œä½¿ç”¨å®ƒä»¬å¯ä»¥æ˜¾è‘—æå‡åº”ç”¨æ€§èƒ½å’Œç¨³å®šæ€§ã€‚